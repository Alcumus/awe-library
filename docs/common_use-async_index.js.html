<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>common/use-async/index.js - awe-library</title>
    
    
    
    
    
    <meta property="og:title" content="awe-library"/>
    <meta property="og:type" content="docs"/>
    <meta property="og:image" content=""/>
    <meta property="og:site_name" content="awe-library"/>
    <meta property="og:url" content=""/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-common_menu.html">common/menu</a><ul class='methods'><li data-type='method'><a href="module-common_menu.html#.menuItems">menuItems</a></li><li data-type='method'><a href="module-common_menu.html#.subMenuHeader">subMenuHeader</a></li><li data-type='method'><a href="module-common_menu.html#.subMenuItems">subMenuItems</a></li></ul></li><li><a href="module-common_offline-data-service.html">common/offline-data-service</a><ul class='methods'><li data-type='method'><a href="module-common_offline-data-service.html#.del">del</a></li><li data-type='method'><a href="module-common_offline-data-service.html#.get">get</a></li><li data-type='method'><a href="module-common_offline-data-service.html#.hydrateDocument">hydrateDocument</a></li><li data-type='method'><a href="module-common_offline-data-service.html#.list">list</a></li><li data-type='method'><a href="module-common_offline-data-service.html#.prepareDocument">prepareDocument</a></li><li data-type='method'><a href="module-common_offline-data-service.html#.set">set</a></li><li data-type='method'><a href="module-common_offline-data-service.html#.useRecord">useRecord</a></li><li data-type='method'><a href="module-common_offline-data-service.html#.useRecordOrCreate">useRecordOrCreate</a></li><li data-type='method'><a href="module-common_offline-data-service.html#~getCount">getCount</a></li></ul></li><li><a href="module-common_offline-data-service_records.html">common/offline-data-service/records</a><ul class='methods'><li data-type='method'><a href="module-common_offline-data-service_records.html#.getRecords">getRecords</a></li><li data-type='method'><a href="module-common_offline-data-service_records.html#.useRecords">useRecords</a></li><li data-type='method'><a href="module-common_offline-data-service_records.html#.useRecordsForType">useRecordsForType</a></li><li data-type='method'><a href="module-common_offline-data-service_records.html#.useStreamedResults">useStreamedResults</a></li><li data-type='method'><a href="module-common_offline-data-service_records.html#.useStreamedResultsForType">useStreamedResultsForType</a></li></ul></li><li><a href="module-common_process.html">common/process</a><ul class='methods'><li data-type='method'><a href="module-common_process.html#.define">define</a></li><li data-type='method'><a href="module-common_process.html#.immediateProcess">immediateProcess</a></li><li data-type='method'><a href="module-common_process.html#.notRunning">notRunning</a></li><li data-type='method'><a href="module-common_process.html#.parameter">parameter</a></li><li data-type='method'><a href="module-common_process.html#.process">process</a></li><li data-type='method'><a href="module-common_process.html#.retrieve">retrieve</a></li><li data-type='method'><a href="module-common_process.html#.send">send</a></li></ul></li><li><a href="module-common_sortable.html">common/sortable</a><ul class='methods'><li data-type='method'><a href="module-common_sortable.html#.Handle">Handle</a></li><li data-type='method'><a href="module-common_sortable.html#~SortableDiv">SortableDiv</a></li><li data-type='method'><a href="module-common_sortable.html#~SortableList">SortableList</a></li><li data-type='method'><a href="module-common_sortable.html#~SortableListItem">SortableListItem</a></li></ul></li><li><a href="module-common_use-async.html">common/use-async</a><ul class='methods'><li data-type='method'><a href="module-common_use-async.html#.useCachedAsync">useCachedAsync</a></li><li data-type='method'><a href="module-common_use-async.html#.useCurrent">useCurrent</a></li><li data-type='method'><a href="module-common_use-async.html#.useCurrentState">useCurrentState</a></li><li data-type='method'><a href="module-common_use-async.html#~useAsync">useAsync</a></li></ul></li><li><a href="module-common_use-event.html">common/use-event</a><ul class='methods'><li data-type='method'><a href="module-common_use-event.html#.useLocalEvent">useLocalEvent</a></li><li data-type='method'><a href="module-common_use-event.html#.useLocalEventImmediate">useLocalEventImmediate</a></li><li data-type='method'><a href="module-common_use-event.html#.useWindowSize">useWindowSize</a></li></ul></li><li><a href="module-dynamic_awe-library_bind.html">dynamic/awe-library/bind</a><ul class='methods'><li data-type='method'><a href="module-dynamic_awe-library_bind.html#.bind">bind</a></li></ul></li><li><a href="module-dynamic_awe-library_document-type-context.html">dynamic/awe-library/document-type-context</a><ul class='methods'><li data-type='method'><a href="module-dynamic_awe-library_document-type-context.html#.useDocumentTypeContext">useDocumentTypeContext</a></li></ul></li><li><a href="module-dynamic_awe-library_fields.html">dynamic/awe-library/fields</a><ul class='methods'><li data-type='method'><a href="module-dynamic_awe-library_fields.html#.getFieldList">getFieldList</a></li><li data-type='method'><a href="module-dynamic_awe-library_fields.html#.getTypeFromField">getTypeFromField</a></li><li data-type='method'><a href="module-dynamic_awe-library_fields.html#.useFieldList">useFieldList</a></li><li data-type='method'><a href="module-dynamic_awe-library_fields.html#.useQuestion">useQuestion</a></li></ul></li><li><a href="module-dynamic_awe-library_generic-list-entry.html">dynamic/awe-library/generic-list-entry</a><ul class='methods'><li data-type='method'><a href="module-dynamic_awe-library_generic-list-entry.html#.genericListEntry">genericListEntry</a></li></ul></li><li><a href="module-dynamic_awe-library_lookup-fields.html">dynamic/awe-library/lookup-fields</a><ul class='methods'><li data-type='method'><a href="module-dynamic_awe-library_lookup-fields.html#.lookup">lookup</a></li></ul></li><li><a href="module-dynamic_awe-library_query.html">dynamic/awe-library/query</a><ul class='methods'><li data-type='method'><a href="module-dynamic_awe-library_query.html#.convertToText">convertToText</a></li><li data-type='method'><a href="module-dynamic_awe-library_query.html#.Query">Query</a></li><li data-type='method'><a href="module-dynamic_awe-library_query.html#.QueryCascade">QueryCascade</a></li></ul></li><li><a href="module-dynamic_awe-library_question-type-def.html">dynamic/awe-library/question-type-def</a><ul class='methods'><li data-type='method'><a href="module-dynamic_awe-library_question-type-def.html#.questionTypeDef">questionTypeDef</a></li><li data-type='method'><a href="module-dynamic_awe-library_question-type-def.html#~allTypes">allTypes</a></li></ul></li><li><a href="module-dynamic_awe-library_use-types.html">dynamic/awe-library/use-types</a><ul class='methods'><li data-type='method'><a href="module-dynamic_awe-library_use-types.html#.getPublishedVersionOfType">getPublishedVersionOfType</a></li><li data-type='method'><a href="module-dynamic_awe-library_use-types.html#.getTypeAndInitialise">getTypeAndInitialise</a></li><li data-type='method'><a href="module-dynamic_awe-library_use-types.html#.useApps">useApps</a></li><li data-type='method'><a href="module-dynamic_awe-library_use-types.html#.useType">useType</a></li><li data-type='method'><a href="module-dynamic_awe-library_use-types.html#.useTypeList">useTypeList</a></li><li data-type='method'><a href="module-dynamic_awe-library_use-types.html#.useTypes">useTypes</a></li></ul></li><li><a href="module-dynamic_awe-library_utils.html">dynamic/awe-library/utils</a><ul class='methods'><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.basicField">basicField</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.behaviour">behaviour</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.classification">classification</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.decorate">decorate</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.decorateFields">decorateFields</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.deepFields">deepFields</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.eventSource">eventSource</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.extractFieldName">extractFieldName</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.fieldBelongsLocally">fieldBelongsLocally</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.fieldNameIs">fieldNameIs</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.getFields">getFields</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.getStates">getStates</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.getTypeFor">getTypeFor</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.hints">hints</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.isNotBlank">isNotBlank</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.isStandardField">isStandardField</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.isStoredInRecord">isStoredInRecord</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.legalDbCharacters">legalDbCharacters</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.legalFieldNameCharacters">legalFieldNameCharacters</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.logErrorOnLongCall">logErrorOnLongCall</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.optionLabel">optionLabel</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.questionCaption">questionCaption</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.questionType">questionType</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.returnValue">returnValue</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.tab">tab</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.tabs">tabs</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.topLevelField">topLevelField</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.trackComponent">trackComponent</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.unique">unique</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.use">use</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.useField">useField</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.useFields">useFields</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.useGroupByFields">useGroupByFields</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.useTables">useTables</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.whenQuestionHasHint">whenQuestionHasHint</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.whenQuestionMatches">whenQuestionMatches</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.whenQuestionTypeIs">whenQuestionTypeIs</a></li><li data-type='method'><a href="module-dynamic_awe-library_utils.html#.whenTrackComponentIs">whenTrackComponentIs</a></li></ul></li></ul><h3>Interfaces</h3><ul><li><a href="BehaviourDefinition.html">BehaviourDefinition</a></li><li><a href="BehaviourKeys.html">BehaviourKeys</a></li><li><a href="Behaviours.html">Behaviours</a><ul class='methods'><li data-type='method'><a href="Behaviours.html#sendMessage">sendMessage</a></li><li data-type='method'><a href="Behaviours.html#sendMessageAsync">sendMessageAsync</a></li></ul></li><li><a href="DeclarationApi.html">DeclarationApi</a><ul class='methods'><li data-type='method'><a href="DeclarationApi.html#after">after</a></li><li data-type='method'><a href="DeclarationApi.html#before">before</a></li><li data-type='method'><a href="DeclarationApi.html#cacheKey">cacheKey</a></li><li data-type='method'><a href="DeclarationApi.html#cacheResult">cacheResult</a></li><li data-type='method'><a href="DeclarationApi.html#cacheRetrieve">cacheRetrieve</a></li><li data-type='method'><a href="DeclarationApi.html#description">description</a></li><li data-type='method'><a href="DeclarationApi.html#important">important</a></li><li data-type='method'><a href="DeclarationApi.html#lruCache">lruCache</a></li><li data-type='method'><a href="DeclarationApi.html#offline">offline</a></li><li data-type='method'><a href="DeclarationApi.html#optional">optional</a></li><li data-type='method'><a href="DeclarationApi.html#required">required</a></li><li data-type='method'><a href="DeclarationApi.html#returns">returns</a></li><li data-type='method'><a href="DeclarationApi.html#timeout">timeout</a></li></ul></li><li><a href="DeepFieldDefinition.html">DeepFieldDefinition</a></li><li><a href="Document.html">Document</a></li><li><a href="DocumentDefinition.html">DocumentDefinition</a></li><li><a href="DocumentRecord.html">DocumentRecord</a></li><li><a href="EventSource.html">EventSource</a><ul class='methods'><li data-type='method'><a href="EventSource.html#addListener">addListener</a></li><li data-type='method'><a href="EventSource.html#removeListener">removeListener</a></li></ul></li><li><a href="FieldDefinition.html">FieldDefinition</a></li><li><a href="HintList.html">HintList</a></li><li><a href="IDocumentTypeContext.html">IDocumentTypeContext</a></li><li><a href="ListOptions.html">ListOptions</a></li><li><a href="MenuItem.html">MenuItem</a></li><li><a href="module-dynamic_awe-library_lookup-fields-FieldLookup.html">FieldLookup</a></li><li><a href="module-dynamic_awe-library_use-types-DocumentRecord.html">DocumentRecord</a></li><li><a href="Process.html">Process</a></li><li><a href="PropertySheetComponents.html">PropertySheetComponents</a></li><li><a href="QueryApi.html">QueryApi</a></li><li><a href="QueryCascadeApi.html">QueryCascadeApi</a></li><li><a href="QueryDefinition.html">QueryDefinition</a></li><li><a href="QuestionTypeDef.html">QuestionTypeDef</a></li><li><a href="RefreshFunction.html">RefreshFunction</a></li><li><a href="SubMenuInfo.html">SubMenuInfo</a></li><li><a href="TableDefinition.html">TableDefinition</a></li><li><a href="TrackComponentDefinition.html">TrackComponentDefinition</a></li><li><a href="WhereDefinition.html">WhereDefinition</a></li></ul><h3>Global</h3><ul><li><a href="global.html#BehaviourPredicate">BehaviourPredicate</a></li><li><a href="global.html#ConfigFunction">ConfigFunction</a></li><li><a href="global.html#DeclarationFunction">DeclarationFunction</a></li><li><a href="global.html#DeepFieldDictionary">DeepFieldDictionary</a></li><li><a href="global.html#DeepFieldFunction">DeepFieldFunction</a></li><li><a href="global.html#DeepFieldPredicate">DeepFieldPredicate</a></li><li><a href="global.html#EventHandler">EventHandler</a></li><li><a href="global.html#HintFunction">HintFunction</a></li><li><a href="global.html#HintPredicate">HintPredicate</a></li><li><a href="global.html#IsActiveFunction">IsActiveFunction</a></li><li><a href="global.html#MenuClickFunction">MenuClickFunction</a></li><li><a href="global.html#MenuItemFunction">MenuItemFunction</a></li><li><a href="global.html#MenuItems">MenuItems</a></li><li><a href="global.html#OfflineProcessor">OfflineProcessor</a></li><li><a href="global.html#Parameter">Parameter</a></li><li><a href="global.html#QuestionPredicateFunction">QuestionPredicateFunction</a></li><li><a href="global.html#RetrieveFunction">RetrieveFunction</a></li><li><a href="global.html#SecurityFunction">SecurityFunction</a></li><li><a href="global.html#SubMenuHeaderProvider">SubMenuHeaderProvider</a></li><li><a href="global.html#SubMenuProvider">SubMenuProvider</a></li><li><a href="global.html#TabPredicate">TabPredicate</a></li><li><a href="global.html#TransformFunction">TransformFunction</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">common/use-async/index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module common/use-async
 */
import React, { useCallback, useEffect, useLayoutEffect, useRef, useState } from 'react'

import PropTypes from 'prop-types'

import isFunction from 'lodash/isFunction'
import isObject from 'lodash/isObject'
import { generate } from 'shortid'

import { batch } from 'common/batched'
import { useRefresh } from 'common/useRefresh'
import { CenteredLoader } from 'common/utils/centered-loader'
import LRU from 'lru-cache'

let incrementalId = 1

export function importComponent(component) {
    let loaded = false
    let current = () => {}
    return function Component(props) {
        const Component = useAsync(async () => {
            let result = current
            if (!loaded) {
                result = await component()
            }
            loaded = true
            return result
        }, current)
        const Draw = useCallback(Component, [Component ? 1 : 0])
        return &lt;Draw {...props} />
    }
}

const cache = new LRU(150)

export function createKey(...ids) {
    return ids
        .flatten()
        .map((i) => (Object.isObject(i) ? i?._id || i?.id || JSON.stringify(i) || 'N' : `${i || '-'}`))
        .join(':')
}

export function useAsyncCached(promiseProducingFunction, defaultValue = null, cacheIds = [], refreshIds = []) {
    const cacheId = createKey(cacheIds)
    const refreshId = createKey(refreshIds, cacheIds)

    return useAsync(
        async () => {
            const result = (await promiseProducingFunction()) || cache.get(cacheId)
            cache.set(cacheId, result)
            return result
        },
        cacheIds.length ? cache.get(cacheId) || defaultValue : defaultValue,
        refreshId
    )
}

/**
 * A hook that allows you to create a function
 * that will be nulled when the current component
 * unmounts.  Calling the function after an unmount
 * will be a noop.
 * @param {function} fn - the function to be wrapped
 * @returns {function} a version of the function that is a
 * noop after the component unmounts
 */
export function useCurrent(fn) {
    let currentSetV = useRef()
    currentSetV.current = fn
    useLayoutEffect(() => {
        return () => (currentSetV.current = null)
    }, [])
    return function (...params) {
        currentSetV.current &amp;&amp; currentSetV.current(...params)
    }
}

/**
 * A hook that does the equivalent of React.useState, however
 * if the component unmounts, the set function of the
 * state will be a noop.  Helps with asyncs that later try to
 * update a component that has been unmounted.
 * @param {...*} [params] - parameters passed to useState
 * @returns {Array} - the same as React useState
 */
export function useCurrentState(...params) {
    const [value, setValue] = useState(...params)
    let currentSetV = useRef()
    currentSetV.current = setValue
    useLayoutEffect(() => {
        return () => (currentSetV.current = null)
    }, [])
    return [
        value,
        function (...params) {
            currentSetV.current &amp;&amp; currentSetV.current(...params)
        },
    ]
}

const testCache = new LRU(2000)
let nextRefreshId = 0

/**
 * A hook to use async data, with additional caching.  This
 * caching is designed to reduce flicker in the UI.  The
 * specific async is given a name and the results will
 * be cached globally and be supplied as the initial result
 * when it is used again.  Data may then be refreshed depending
 * on a separate run id.
 *
 * useCachedAsync needs handling with care so that you don't
 * accidentally use cached data from a different purpose. When
 * used appropriately it makes the UI much more responsive.
 *
 * @param {string} purpose - this should be a unique string to cache
 * data of a particular type
 * @param {function(...*) : Promise} promiseProducingFunction - the function
 * that will retrieve the async data
 * @param {*} [defaultValue] - a value to use when there is no cached data
 * @param {string} [refId=standard] - an id that indicates the cache key to use, this should
 * is used in conjunction with `purpose` to create a cache key
 * @param {string} [runId] - an id that indicates that even if the keys match
 * that the function should be run again and the data updated when
 * it is available
 * @returns {*} the results of the function, the cached value or the default value
 * as appropriate
 * @example
 export function useRecordsForType(type, where, sort, options) {
    return useCachedAsync(
        'getRecords', // purpose of the async
        async () => { // function to get the records
            if (!type) return []
            const typeDef = Object.isObject(type) ? type : await get(type)
            await initialize(typeDef)
            await raiseAsync('update-records', [typeDef])
            return getRecords(typeDef?.database, typeDef?.table, {}, sort, options)
        },
        [], // default value if no cache
        JSON.stringify({ type, where, sort, options }) // unique cache key when added to purpose
    )
}
 */
export function useCachedAsync(purpose, promiseProducingFunction, defaultValue = null, refId = 'standard', runId) {
    const [instanceId] = useState(() => nextRefreshId++)
    runId = runId || `_${instanceId}_`
    const key = `${JSON.stringify(refId)}:${purpose}`
    let [value, processed] = useAsync(
        async function () {
            return [await promiseProducingFunction(), true]
        },
        [testCache.get(key) || defaultValue, false],
        JSON.stringify({
            refId,
            runId,
        })
    )
    if (!processed) {
        return testCache.get(key) || defaultValue
    } else {
        testCache.set(key, value)
        return value
    }
}

export const CancelAsync = Symbol('CancelAsync')


/**
 * A hook to retrieve data from an async function.
 * @param {function(...*):Promise} promiseProducingFunction - the async function to run
 * @param {*} [defaultValue=null] - a default value to use until the function returns
 * @param {string} [refId=standard] - a value that indicates the resource and if it doesn't match, causes the function to run again
 * @returns {*} the result of the function or the default value as appropriate
 * @example
 const fields = useAsync(
 async () => {
            const type = await getType(target.actionType)
            await initialize(type)
            return type.sendMessage('fields', [])
        },
 [],
 target.actionType
 )

 */
function useAsync(promiseProducingFunction, defaultValue = null, refId = 'standard') {
    let [, setValue] = useState()
    let currentSetV = useRef()
    currentSetV.current = setValue
    useLayoutEffect(() => {
        return () => (currentSetV.current = null)
    }, [])
    // noinspection JSPrimitiveTypeWrapperUsage
    let useId = isObject(refId) ? (refId.__id = refId.__id || generate()) : refId
    let execute = useRef({ value: defaultValue })

    if (useId !== execute.current.id) {
        execute.current.id = useId
        execute.current.value = defaultValue
        let tempValue = promiseProducingFunction
        promiseProducingFunction = !isFunction(promiseProducingFunction)
            ? async () => tempValue
            : promiseProducingFunction
        Promise.resolve(promiseProducingFunction()).then(
            (v) => {
                if (v === CancelAsync) return
                execute.current.value = v || defaultValue
                batch(() => currentSetV.current &amp;&amp; currentSetV.current(incrementalId++))
            },
            () => {}
        )
    }
    return execute.current.value
}

function isAsync(fn, name) {
    if (typeof fn !== 'function') return false
    if (fn.constructor.name === 'AsyncFunction') return true
    if (fn._isAsync) return true
    if (fn._isAsync === false) return false
    return !!(name &amp;&amp; !name.startsWith('on') &amp;&amp; fn.length === 0)
}

function returnNull() {
    return null
}

export function Async({ children, component, load, error, fallback, sequence = Date.now(), ...props }) {
    let exception, setException
    let refresh
    const results = useRef(new Array(load.length))
    const isLoaded = useRef(true)
    useEffect(() => {
        return () => {
            isLoaded.current = false
        }
    }, [])
    const rendered = useRef()
    children =
        children ||
        component ||
        function () {
            return &lt;span>Nothing to do&lt;/span>
        }

    function Content({ results }) {
        return children(results)
    }

    function Embedded() {
        const Fallback = fallback === null ? returnNull : fallback || (() => &lt;CenteredLoader />)
        const Error = error || returnNull
        refresh = useRefresh()
        ;[exception, setException] = useState(null)
        load = Array.isArray(load) ? load : [load]
        if (exception) return &lt;Error error={exception} {...props} />
        if (Fallback &amp;&amp; !results.current.wasSet) return &lt;Fallback {...props} />
        return &lt;Content results={results.current} />
    }

    useEffect(() => {
        ;(async function processAsync() {
            try {
                if (rendered.current !== sequence) {
                    results.current = await Promise.all(load.map((l) => Promise.resolve(l(props))))
                }
                results.current.wasSet = true
                isLoaded.current &amp;&amp; refresh()
            } catch (e) {
                setException(e)
                console.error('Error in &lt;Async>: ' + e?.toString?.())
                //eslint-disable-next-line no-console
                console.log(component?.name, component, children)
                //eslint-disable-next-line no-console
                console.trace('error in async')
            }
        })()
    })
    return &lt;Embedded />
}

export function withAsyncProps(Component, Fallback) {
    let id = 1
    return (props) => {
        const results = useRef({})
        const total = useRef(0)

        function Embedded() {
            const ongoingProps = { ...props }
            let [, refresh] = useState(0)
            const done = useRef(false)
            const toRemove = useRef([])
            useEffect(() => {
                return () => {
                    refresh = null
                }
            }, [])
            if (done.current === false) {
                done.current = generate()
                let async = Object.entries(props).filter(
                    ([name, value]) => name !== 'refresh' &amp;&amp; typeof value === 'function' &amp;&amp; isAsync(value, name)
                )
                total.current = total.current || async.length
                toRemove.current = async.map(([name]) => name)
                for (const [name, value] of async) {
                    let promise = value()
                    if (!promise) {
                        console.error('No result', name, Component)
                    } else if (!promise.then) {
                        console.error('Function is not thenable')
                    } else {
                        promise.then(
                            (result) => {
                                total.current = total.current - 1
                                results.current[name] = result
                                refresh &amp;&amp; refresh(id++)
                            },
                            (err) => {
                                total.current = total.current - 1
                                results.current[name + 'Error'] = err
                                refresh &amp;&amp; refresh(id++)
                            }
                        )
                    }
                }
            }
            for (const remove of toRemove.current) {
                delete ongoingProps[remove]
            }
            if (Fallback !== undefined &amp;&amp; total.current > 0) {
                if (!Fallback) return null
                return &lt;Fallback key={done.current} {...ongoingProps} {...results.current} />
            } else {
                return &lt;Component key={done.current} {...ongoingProps} {...results.current} />
            }
        }

        return &lt;Embedded />
    }
}

export function asyncProp(fn) {
    if (fn) {
        fn._isAsync = true
        return fn
    } else {
        return fn
    }
}

export function standard(fn) {
    fn._isAsync = false
    return fn
}

export { useAsync }
export default useAsync

Async.propTypes = {
    children: PropTypes.any,
    component: PropTypes.any,
    error: PropTypes.any,
    fallback: PropTypes.any,
    load: PropTypes.oneOfType([PropTypes.arrayOf(PropTypes.func), PropTypes.func]).isRequired,
    sequence: PropTypes.any,
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.5</a> on Wed Sep 02 2020 09:29:45 GMT+0100 (British Summer Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
